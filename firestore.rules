
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper: Is the user logged in?
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper: Is the user an Admin?
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.position == 'Admin';
    }

    // --- ADMIN OVERRIDE ---
    // Admins have full access to everything. This rule is checked first.
    match /{document=**} {
      allow read, write: if isAdmin();
    }

    // Helper: Check membership in the specific project sub-collection
    function isProjectMember(projectId) {
      return isSignedIn() && 
        exists(/databases/$(database)/documents/projects/$(projectId)/members/$(request.auth.uid));
    }

    // --- PROJECT SCOPE ---
    match /projects/{projectId} {
      // Allow any signed-in user to see the list of projects,
      // but only allow members to read the full document details.
      allow list: if isSignedIn();
      allow get: if isProjectMember(projectId);
      
      // Project metadata updates (PMs/Directors)
      allow update: if isProjectMember(projectId); 

      // 1. Dashboard Summaries (This fixes your Dashboard Page)
      // This matches /projects/{projectId}/dashboards/{anyDoc}
      match /dashboards/{docId} {
        allow read, list: if isProjectMember(projectId);
        // Only allow writes via Server Actions (Transaction logic)
        // If you need client-side writes, change this to:
        allow write: if isProjectMember(projectId);
      }

      // 2. Daily Reports & Items
      match /daily_reports/{reportId} {
        allow read, list, create: if isProjectMember(projectId);
        
        match /items/{itemId} {
          allow read, list, create: if isProjectMember(projectId);
        }
      }

      // 3. Project Members (Crucial for the exists() check to work & Migration)
      match /members/{memberId} {
        // Allow any signed-in user to perform migration tasks.
        // This is a key change to fix the "Catch-22" permission error.
        allow read, list, create, delete, write: if isSignedIn();
      }

      // 4. Activities and Sub-activities (Fix for Integrity Check)
      match /activities/{activityId} {
        allow read, list: if isSignedIn(); // Allow reading activities for admin tools
        
        match /subactivities/{subActivityId} {
           allow read, list: if isSignedIn(); // Allow reading sub-activities for admin tools
        }
      }
    }

    // --- GLOBAL SCOPE ---
    match /companies/{companyId} {
      allow read: if isSignedIn();
    }
    
    // This is the new rule to allow reading the equipment list.
    match /equipment/{equipmentId} {
      allow read, list: if isSignedIn();
    }

    match /units/{unitId} {
      allow read: if isSignedIn();
    }
    
    match /users/{userId} {
      allow read, list: if isSignedIn(); // Allow list for migration tool
      allow write: if isSignedIn() && request.auth.uid == userId;
    }

    // --- COLLECTION GROUPS ---
    // Specifically for the "Global Dashboards" or "Cross-Project" views
    match /{path=**}/dashboards/{docId} {
      allow read, list: if isSignedIn(); 
    }
  }
}

